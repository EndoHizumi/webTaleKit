# WebTaleKit セーブ・ロード機能 設計仕様書

## 1. 概要

WebTaleKitのゲームデータを保存・読み込みするセーブ・ロード機能の設計仕様。プレイヤーがゲーム進行を保存し、後で続きからプレイできるようにする機能を実装する。

## 2. 基本設計

### 2.1 保存データの構成

セーブデータには以下の情報を含める：

- セーブ日時（タイムスタンプ）
- シナリオの進行状況（ScenarioManager.progress）
- 現在のシナリオインデックス
- 表示中の画像情報（位置、サイズ、反転情報など）
- 選択履歴
- スクリプト変数（sceneFile内の変数）
- 現在のシーン名
- BGM情報（ソースと再生状況）
- バージョン情報（セーブデータの互換性確保）
- スクリーンショット（オプション）

### 2.2 ストレージ方式

- プライマリ: localStorage
- 容量制限: 約5MB
- 必要に応じてIndexedDBへの拡張も検討

## 3. 機能仕様

### 3.1 Core.js への追加機能

#### 3.1.1 セーブ機能

```
saveGame(slotNumber): Promise<boolean>
```

- 現在のゲーム状態をJSONに変換
- ストレージにslotNumberをキーとして保存
- 成功時はtrueを返す

#### 3.1.2 ロード機能

```
loadGame(slotNumber): Promise<boolean>
```

- slotNumberに対応するセーブデータを読み込み
- シーンの再ロード
- 進行状況・変数・表示画像・BGMなどの復元
- 成功時はtrueを返す

#### 3.1.3 WebTaleScript用ハンドラー

```
saveHandler(scenarioObject): Promise<void>
loadHandler(scenarioObject): Promise<void>
```

- コマンドリスト拡張により`<save>`と`<load>`タグをサポート

### 3.2 UI実装

#### 3.2.1 セーブ・ロード画面

- タブ切り替え方式（セーブ/ロード）
- スロット一覧表示（デフォルト10スロット）
- 各スロットにはタイムスタンプ、シーン名、スクリーンショット（オプション）を表示
- 「戻る」ボタンでゲームに戻る

#### 3.2.2 表示・非表示の制御

```
showSaveLoadScreen(mode='save'): void
```

- mode: 'save'または'load'
- セーブ・ロード画面のDOM要素を表示

## 4. 拡張機能

### 4.1 オートセーブ

- 選択肢選択後や特定シーン区切りで自動保存
- 専用の「オートセーブ」スロットを用意

### 4.2 ショートカットキー

- F5: セーブ画面表示
- F9: ロード画面表示

### 4.3 スクリーンショット

- Canvas要素から現在の画面をJPEG形式で保存
- 容量節約のため圧縮率を調整

### 4.4 バージョン管理

- セーブデータにバージョン情報を含め、アップデート時の互換性を確保
- 旧バージョンのセーブデータを新バージョンで読み込む際の変換処理

## 5. 実装手順

1. Core.jsに基本機能の実装（saveGame, loadGame）
2. WebTaleScriptハンドラーの追加（saveHandler, loadHandler）
3. UI画面の実装（HTML/CSS/JS）
4. 動作テスト
5. 拡張機能の実装（オートセーブ、スクリーンショット等）

## 6. 注意事項

- シリアライズできない要素（DOM要素、循環参照等）の扱い
- LocalStorageの容量制限への対応
- 非同期処理の適切な扱い
- クロスブラウザ対応の確保

## 7. 将来的な拡張性

- クラウドセーブ機能
- エクスポート/インポート機能
- セーブデータの暗号化
- 複数プロファイル対応
